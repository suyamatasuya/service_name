<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Care Record</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag 'care_record_edit' %>
</head>
<body class="body">
  <main class="main container">
    <div class="text-center">
      <h1 class="h1 mt-5 mb-4">記録内容を編集</h1>

      <!-- Form to edit a care record -->
      <form id="edit-care-record-form" action="/api/care_records/<%= @care_record.id %>" method="put">
        <div class="form-group">
          <label for="date">日付</label>
          <input type="date" id="date" name="date" class="form-control" value="<%= @care_record.date %>">
        </div>

        <div class="form-group">
          <label for="care-type">ケアタイプ</label>
          <select id="care-type" name="care-type" class="form-control">
            <option value="">選択してください</option>
            <option value="stretch" <%= 'selected' if @care_record.care_type == 'stretch' %>>ストレッチ</option>
            <option value="strength_training" <%= 'selected' if @care_record.care_type == 'strength_training' %>>筋力トレーニング</option>
            <option value="exercise" <%= 'selected' if @care_record.care_type == 'exercise' %>>エクササイズ</option>
            <option value="other" <%= 'selected' if @care_record.care_type == 'other' %>>その他</option>
          </select>
        </div>

        <div class="form-group">
          <label for="description">ケア内容やメモ</label>
          <textarea id="description" name="description" class="form-control"><%= @care_record.description %></textarea>
        </div>

        <!-- Submit button -->
        <button type="submit" class="button btn btn-primary mb-2">更新</button>

        <div class="mt-2">
          <%= link_to '戻る', care_records_path, class: 'btn btn-secondary' %>
        </div>
      </form>

    </div>
  </main>

  <script>
    $(document).ready(function() {
      $("#edit-care-record-form").on("submit", function(event) {
        event.preventDefault();

        var date = $("#date").val();
        var careType = $("#care-type").val();
        var description = $("#description").val();

        var payload = {
          care_record: {
            date: date,
            care_type: careType,
            description: description,
          }
        };

        $.ajax({
          url: '/api/care_records/' + <%= @care_record.id %>,
          type: 'PUT',
          data: JSON.stringify(payload),
          contentType: 'application/json',
          success: function(response) {
            console.log(response);
            // フラッシュメッセージを設定してからリダイレクト
            sessionStorage.setItem("flashMessage", "ケア記録を更新しました");
            window.location.href = '/care_records';
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.log(errorThrown);
          }
        });
      });
    });
  </script>
</body>
</html>
