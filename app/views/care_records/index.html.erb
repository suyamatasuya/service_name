<%= stylesheet_link_tag 'care_records_index' %>
<div class="container">
    <div class="text-center">
        <h1 class="mt-5 mb-4">ケア記録一覧</h1>
        <button class="btn menu-btn mb-4" type="button" id="menuToggle" onclick="window.location.href='/care_records/new'">
            ケア記録を作成
        </button>
            
        <button class="btn menu-btn mb-4 ml-3" type="button" id="graphToggle">
            グラフ表示
        </button>

        <button class="btn menu-btn mb-4 ml-3" type="button" onclick="window.location.href='/care_settings/new'">
          ケア時間設定
        </button>

        <div class="help-icon" onmouseover="showHelpPopup()" onmouseout="hideHelpPopup()">
            <div class="help-popup" id="help-popup">
                <h2>使い方</h2>
                <ol>
                    <li>
                      <p><strong>ケア記録の作成:</strong> 予定日を設定し、ケア記録を作成します。これにより、カレンダーにケア予定日が自動的に登録されます。</p>
                    </li>
                    <li>
                      <p><strong>メニューの利用:</strong> カレンダーに登録されたケアをクリックすると、関連メニューが表示されます。</p>
                    </li>
                    <li>
                      <p><strong>痛みの状態:</strong> メニューから「完了」を選択し、その日の痛みの状態を記録します。これにより、痛みの状態がグラフに反映され、日々の変化がトラッキングできます。</p>
                    </li>
                    <li>
                      <p><strong>医療機関への受診:</strong> 痛みが1週間以上続く、または増してきた場合には、記録を参考にして医療機関へ受診をおすすめします。</p>
                    </li>
                </ol>
            </div>
        </div>

        <div class="d-none mb-4" id="graphContent">
            <ul class="nav nav-tabs mb-4" id="careRecordsTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="neck-tab" data-toggle="tab" href="#neck" role="tab" aria-controls="neck" aria-selected="true">首</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="back-tab" data-toggle="tab" href="#back" role="tab" aria-controls="back" aria-selected="false">腰</a>
                </li>
            </ul>

            <div class="tab-content" id="careRecordsTabContent">
                <div class="tab-pane fade show active" id="neck" role="tabpanel" aria-labelledby="neck-tab">
                    <!-- 首のグラフ -->
                    <canvas id="neckCareRecordsChart" width="400" height="200"></canvas>
                </div>
                <div class="tab-pane fade" id="back" role="tabpanel" aria-labelledby="back-tab">
                    <!-- 腰のグラフ -->
                    <canvas id="backCareRecordsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div id="calendar"></div>

        <!-- ここで削除ボタンを別のセクションに移動 -->
        <div class="delete-button-section">
          <button class="btn menu-btn mb-4 ml-3" type="button" id="deleteToggle">
            ケア記録を削除
          </button>
        </div>

         <!-- サイドバーの内容 -->
        <div class="d-none mb-4" id="sidebarMenu">
          <div class="card card-body">
            <a href="#" class="btn menu-btn" id="delete-neck-records">首の記録を削除</a>
            <a href="#" class="btn menu-btn" id="delete-back-records">腰の記録を削除</a>
          </div>
        </div>
    </div>

    <!-- Care Record Modal -->
    <div class="modal fade" id="careRecordModal" tabindex="-1" role="dialog" aria-labelledby="careRecordModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="careRecordModalLabel">ケア記録詳細</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる" id="modal-close-button">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- ここにケア記録の詳細を表示します -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="edit-button">編集</button>
                    <button type="button" class="btn btn-danger" id="delete-button">削除</button>
                    <button type="button" class="btn btn-success" id="complete-button">完了</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="modal-footer-close-button">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div class="modal fade" id="completionModal" tabindex="-1" role="dialog" aria-labelledby="completionModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="completionModalLabel">ケア記録完了</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="閉じる" id="modal-close-button-2">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                        <label for="face-scale">現在の痛みの強さを教えてください</label>
                        <div class="face-scale-container mt-3">
                            <button class="face-scale-option btn btn-light" data-face-scale="1">😀</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="2">🙂</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="3">😐</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="4">🙁</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="5">😭</button>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="completion-button">完了</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="modal-footer-close-button-2">閉じる</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>

        document.getElementById('deleteToggle').addEventListener('click', function() {
        var sidebarMenu = document.getElementById('sidebarMenu');
        if (sidebarMenu.classList.contains('d-none')) {
            sidebarMenu.classList.remove('d-none');
        } else {
            sidebarMenu.classList.add('d-none');
        }
    });

        function careTypeToJapanese(care_type) {
            var careTypeTranslations = {
                "strength_training": "筋トレ",
                "stretch": "ストレッチ",
                "other": "その他",
                "exercise": "エクササイズ",
            };
            return careTypeTranslations[care_type] || care_type;
        }

        function faceScaleToEmoji(face_scale) { 
            var faceScaleMap = {
                1: "😀",
                2: "🙂",
                3: "😐",
                4: "🙁",
                5: "😭"
            };
            return faceScaleMap[face_scale] || "";
        }

        window.translations = {
            edit_button: "<%= t('.edit_button') %>",
            delete_button: "<%= t('.delete_button') %>",
            complete_button: {
                complete: "<%= t('.complete_button.complete') %>",
                completed: "<%= t('.complete_button.completed') %>"
            }
        };
            
        var calendarEl = document.getElementById('calendar');
        var calendar = null;

        $(document).ready(function() {
            $('#modal-close-button, #modal-footer-close-button').click(function() {
                $('#careRecordModal').modal('hide');
            });

            $('.face-scale-option').click(function() {
                $('.face-scale-option').removeClass('btn-primary').addClass('btn-light');
                $(this).removeClass('btn-light').addClass('btn-primary');
            });

            $('#edit-button').click(function() {
                var currentRecordId = $('#careRecordModal').data('record-id');
                window.location.href = '/care_records/' + currentRecordId + '/edit';
            });

            $('#delete-button').click(function() {
                var currentRecordId = $('#careRecordModal').data('record-id');
                $.ajax({
                    url: '/api/care_records/' + currentRecordId,
                    type: 'DELETE',
                    success: function(result) {
                        $('#careRecordModal').modal('hide');
                        fetchCareRecords();  // カレンダーのイベントを再取得
                    }
                });
            });

            $('#delete-neck-records, #delete-back-records').click(function(e) {
                e.preventDefault();
                var symptom = $(this).attr('id') === 'delete-neck-records' ? 'neck' : 'back';
                var confirmMessage = symptom === 'neck' ? '首の記録を本当に削除しますか？' : '腰の記録を本当に削除しますか？';
                if (window.confirm(confirmMessage)) {
                    deleteRecordsBySymptom(symptom);
                }
            });

            function deleteRecordsBySymptom(symptom) {
                $.ajax({
                    url: `/api/care_records/delete_by_symptom?symptom=${symptom}`,
                    type: 'DELETE',
                    success: function(result) {
                        fetchCareRecords();  // カレンダーのイベントを再取得
                    },
                    error: function(error) {
                        alert('エラーが発生しました。再度お試しください。');
                    }
                });
            }

            function fetchCareRecords() {
                // カレンダーの初期化
                if (calendar) {
                    calendar.destroy();
                }
                calendar = new Calendar(calendarEl, {
                    plugins: [dayGridPlugin],
                    initialView: 'dayGridMonth',
                    locale: 'ja',
                    buttonText: {
                        today: '今日'
                    },
                    eventClick: function(info) {
                    }
                });
                calendar.render();

                $.get("/api/care_records", function(data) {
                    data.forEach(function(care_record) {
                        var title = careTypeToJapanese(care_record.care_type);
                        if (care_record.symptom) {
                            title = care_record.symptom === 'neck' ? '首: ' + title : '腰: ' + title;
                        }
                        if (care_record.completed && care_record.face_scale !== null) {
                            title += " - " + faceScaleToEmoji(care_record.face_scale); 
                        }
                        calendar.addEvent({
                            id: care_record.id,
                            title: title,
                            start: care_record.date,
                            color: care_record.completed ? 'green' : 'lightblue'
                        });
                    });
                });
            }

            fetchCareRecords();

            document.getElementById('graphToggle').addEventListener('click', function() {
            var graph = document.getElementById('graphContent');
            if (graph.classList.contains('d-none')) {
                graph.classList.remove('d-none');
            } else {
                graph.classList.add('d-none');
            }
        });
        });

        function showHelpPopup() {
            document.getElementById('help-popup').style.display = 'block';
        }

        function hideHelpPopup() {
            document.getElementById('help-popup').style.display = 'none';
        }
    </script>
    <%= javascript_pack_tag 'care_records/index' %>
    <%= javascript_pack_tag 'care_records/graph' %>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</div>