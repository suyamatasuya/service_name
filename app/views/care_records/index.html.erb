<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚±ã‚¢è¨˜éŒ²ä¸€è¦§</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    
    <%= stylesheet_link_tag 'care_records_index' %>
</head>
<body>
    <div class="container">
        <div class="text-center">
            <h1 class="mt-5 mb-4"><%= t('.title') %></h1>

            <button class="btn menu-btn mb-4" type="button" id="menuToggle">
                ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </button>

            <button class="btn menu-btn mb-4 ml-3" type="button" id="graphToggle">
              ã‚°ãƒ©ãƒ•è¡¨ç¤º
            </button>

            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å†…å®¹ -->
            <div class="d-none mb-4" id="sidebarMenu">
                <div class="card card-body">
                    <a href="/care_records/new" class="btn menu-btn" id="new-care-record"><%= t('.new_care_record_button') %></a>
                    <a href="#" class="btn menu-btn" id="delete-neck-records">é¦–ã®è¨˜éŒ²ã‚’å‰Šé™¤</a>
                    <a href="#" class="btn menu-btn" id="delete-back-records">è…°ã®è¨˜éŒ²ã‚’å‰Šé™¤</a>
                </div>
            </div>

            <div class="d-none mb-4" id="graphContent">
                <ul class="nav nav-tabs mb-4" id="careRecordsTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="neck-tab" data-toggle="tab" href="#neck" role="tab" aria-controls="neck" aria-selected="true">é¦–</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="back-tab" data-toggle="tab" href="#back" role="tab" aria-controls="back" aria-selected="false">è…°</a>
                    </li>
                </ul>
                <div class="tab-content" id="careRecordsTabContent">
                    <div class="tab-pane fade show active" id="neck" role="tabpanel" aria-labelledby="neck-tab">
                        <!-- é¦–ã®ã‚°ãƒ©ãƒ• -->
                        <canvas id="neckCareRecordsChart" width="400" height="200"></canvas>
                    </div>
                    <div class="tab-pane fade" id="back" role="tabpanel" aria-labelledby="back-tab">
                        <!-- è…°ã®ã‚°ãƒ©ãƒ• -->
                        <canvas id="backCareRecordsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div id="calendar"></div>
        </div>

        <!-- Care Record Modal -->
        <div class="modal fade" id="careRecordModal" tabindex="-1" role="dialog" aria-labelledby="careRecordModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="careRecordModalLabel">ã‚±ã‚¢è¨˜éŒ²è©³ç´°</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹" id="modal-close-button">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- ã“ã“ã«ã‚±ã‚¢è¨˜éŒ²ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="edit-button">ç·¨é›†</button>
                        <button type="button" class="btn btn-danger" id="delete-button">å‰Šé™¤</button>
                        <button type="button" class="btn btn-success" id="complete-button">å®Œäº†</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="modal-footer-close-button">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completion Modal -->
        <div class="modal fade" id="completionModal" tabindex="-1" role="dialog" aria-labelledby="completionModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="completionModalLabel">ã‚±ã‚¢è¨˜éŒ²å®Œäº†</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹" id="modal-close-button-2">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <label for="face-scale">ç¾åœ¨ã®ç—›ã¿ã®å¼·ã•ã‚’æ•™ãˆã¦ãã ã•ã„</label>
                        <div class="face-scale-container mt-3">
                            <button class="face-scale-option btn btn-light" data-face-scale="1">ğŸ˜€</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="2">ğŸ™‚</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="3">ğŸ˜</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="4">ğŸ™</button>
                            <button class="face-scale-option btn btn-light" data-face-scale="5">ğŸ˜­</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>

            document.getElementById('menuToggle').addEventListener('click', function() {
                var menu = document.getElementById('sidebarMenu');
                if (menu.classList.contains('d-none')) {
                    menu.classList.remove('d-none');
                } else {
                    menu.classList.add('d-none');
                }
            });

            function careTypeToJapanese(care_type) {
                var careTypeTranslations = {
                    "strength_training": "ç­‹ãƒˆãƒ¬",
                    "stretch": "ã‚¹ãƒˆãƒ¬ãƒƒãƒ",
                    "other": "ãã®ä»–",
                    "exercise": "ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º",
                };
                return careTypeTranslations[care_type] || care_type;
            }

            function faceScaleToEmoji(face_scale) { 
                var faceScaleMap = {
                    1: "ğŸ˜€",
                    2: "ğŸ™‚",
                    3: "ğŸ˜",
                    4: "ğŸ™",
                    5: "ğŸ˜­"
                };
                return faceScaleMap[face_scale] || "";
            }

            window.translations = {
                edit_button: "<%= t('.edit_button') %>",
                delete_button: "<%= t('.delete_button') %>",
                complete_button: {
                    complete: "<%= t('.complete_button.complete') %>",
                    completed: "<%= t('.complete_button.completed') %>"
                }
            };
            
            var calendarEl = document.getElementById('calendar');
            var calendar = null;

            $(document).ready(function() {
                $('#modal-close-button, #modal-footer-close-button').click(function() {
                    $('#careRecordModal').modal('hide');
                });

                $('.face-scale-option').click(function() {
                    $('.face-scale-option').removeClass('btn-primary').addClass('btn-light');
                    $(this).removeClass('btn-light').addClass('btn-primary');
                });

                $('#edit-button').click(function() {
                    var currentRecordId = $('#careRecordModal').data('record-id');
                    window.location.href = '/care_records/' + currentRecordId + '/edit';
                });

                $('#delete-button').click(function() {
                    var currentRecordId = $('#careRecordModal').data('record-id');
                    $.ajax({
                        url: '/api/care_records/' + currentRecordId,
                        type: 'DELETE',
                        success: function(result) {
                            $('#careRecordModal').modal('hide');
                            fetchCareRecords();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—
                        }
                    });
                });

                $('#delete-neck-records, #delete-back-records').click(function(e) {
                    e.preventDefault();
                    var symptom = $(this).attr('id') === 'delete-neck-records' ? 'neck' : 'back';
                    var confirmMessage = symptom === 'neck' ? 'é¦–ã®è¨˜éŒ²ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' : 'è…°ã®è¨˜éŒ²ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
                    if (window.confirm(confirmMessage)) {
                        deleteRecordsBySymptom(symptom);
                    }
                });

                function deleteRecordsBySymptom(symptom) {
                    $.ajax({
                        url: `/api/care_records/delete_by_symptom?symptom=${symptom}`,
                        type: 'DELETE',
                        success: function(result) {
                            fetchCareRecords();  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—
                        },
                        error: function(error) {
                            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                    });
                }

                function fetchCareRecords() {
                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
                    if (calendar) {
                        calendar.destroy();
                    }
                    calendar = new Calendar(calendarEl, {
                        plugins: [dayGridPlugin],
                        initialView: 'dayGridMonth',
                        locale: 'ja',
                        buttonText: {
                            today: 'ä»Šæ—¥'
                        },
                        eventClick: function(info) {
                            // ... ãã®ä»–ã®è¨­å®šã¯ãã®ã¾ã¾ ...
                        }
                    });
                    calendar.render();

                    $.get("/api/care_records", function(data) {
                        data.forEach(function(care_record) {
                            var title = careTypeToJapanese(care_record.care_type);
                            if (care_record.symptom) {
                                title = care_record.symptom === 'neck' ? 'é¦–: ' + title : 'è…°: ' + title;
                            }
                            if (care_record.completed && care_record.face_scale !== null) {
                                title += " - " + faceScaleToEmoji(care_record.face_scale); 
                            }
                            calendar.addEvent({
                                id: care_record.id,
                                title: title,
                                start: care_record.date,
                                color: care_record.completed ? 'green' : 'lightblue'
                            });
                        });
                    });
                }

                fetchCareRecords();

                document.getElementById('graphToggle').addEventListener('click', function() {
                var graph = document.getElementById('graphContent');
                if (graph.classList.contains('d-none')) {
                    graph.classList.remove('d-none');
                } else {
                    graph.classList.add('d-none');
                }
            });
            });
        </script>
        <%= javascript_pack_tag 'care_records/index' %>
        <%= javascript_pack_tag 'care_records/graph' %>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    </div>
</body>
</html>
